# This workflow runs daily to check for updates to OpenAPI specifications. If updates are found,
# it creates a new branch, commits the changes, and opens a pull request with relevant details.
# Then triggers the auto-review and merge workflow to ensure the PR is reviewed and merged. Finally, it triggers connector regeneration for any updated specifications.
name: OpenAPI Dependabot

on:
  schedule:
    - cron: "0 2 * * *"  # Run daily at 2 AM UTC
  workflow_dispatch:  # Allow manual triggers

jobs:
  update-openapi-specs:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout api-specs repo
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Set up Ballerina
        uses: ballerina-platform/setup-ballerina@v1.1.0
        with:
          version: 2201.13.1

      - name: Configure Git
        run: |
          git config --global user.email "ballerina-bot@users.noreply.github.com"
          git config --global user.name "ballerina-bot"

      - name: Run Dependabot Monitor
        run: |
          cd dependabot
          bal clean

          # Retry logic for transient Ballerina Central failures
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            if bal run; then
              echo "Build succeeded!"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Build failed, retrying in 30 seconds..."
              sleep 30
              # Clear cache before retry
              rm -rf ~/.ballerina/repositories/central.ballerina.io/cache 2>/dev/null || true
            else
              echo "Build failed after $MAX_RETRIES attempts"
              exit 1
            fi
          done

          cd ..

      - name: Check for updates
        run: |
          if [ -f "UPDATE_SUMMARY.txt" ]; then
            echo "UPDATES_FOUND=true" >> $GITHUB_ENV
            echo "Updates detected!"
          else
            echo "UPDATES_FOUND=false" >> $GITHUB_ENV
            echo "No updates found"
          fi

      - name: Create and Push Branch
        if: env.UPDATES_FOUND == 'true'
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="openapi-update-${TIMESTAMP}"
          echo "Creating branch: ${BRANCH_NAME}"
          git checkout -b "${BRANCH_NAME}"
          git add openapi/ repos.json UPDATE_SUMMARY.txt
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore: Update OpenAPI specifications"
          git push -u origin "$BRANCH_NAME"
          echo "Branch pushed successfully"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

      - name: Create Pull Request
        if: env.UPDATES_FOUND == 'true'
        run: |
          UPDATE_SUMMARY=$(cat UPDATE_SUMMARY.txt)
          PR_TITLE="[Dependabot] chore: Update OpenAPI Specifications - $(date +%Y-%m-%d)"

          # Create PR body using heredoc for proper formatting
          PR_BODY=$(cat <<EOF
          ## OpenAPI Specification Updates

          This PR contains automated updates to OpenAPI specifications detected by the Dependabot monitor.

          ### Changes:
          ${UPDATE_SUMMARY}

          ### Structure:
          All specifications follow the standard structure:
          - openapi/{vendor}/{api}/{version}/openapi.yaml
          - openapi/{vendor}/{api}/{version}/.metadata.json

          ### Checklist:
          - Review specification changes
          - Verify connector generation works
          - Run tests
          - Update documentation if needed

          ---
          This PR was automatically generated by the OpenAPI Dependabot
          EOF
          )

          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "openapi-update,automated,dependencies")

          echo "Pull Request created successfully!"
          echo "PR_URL: $PR_URL"

          # Extract PR number from URL
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV

      - name: Wait for Auto-Merge
        if: env.UPDATES_FOUND == 'true' && env.PR_NUMBER != ''
        run: |
          echo "Waiting for auto-review and merge workflow..."
          MAX_WAIT=300  # 5 minutes maximum wait time
          ELAPSED=0
          INTERVAL=10

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))

            # Check PR status
            PR_STATE=$(gh pr view "$PR_NUMBER" --json state -q '.state')

            if [ "$PR_STATE" = "MERGED" ]; then
              echo "PR #${PR_NUMBER} has been merged successfully!"
              echo "MERGE_SUCCESSFUL=true" >> $GITHUB_ENV
              break
            elif [ "$PR_STATE" = "CLOSED" ]; then
              echo "PR #${PR_NUMBER} was closed without merging"
              echo "MERGE_SUCCESSFUL=false" >> $GITHUB_ENV
              exit 1
            fi

            echo "Still waiting... (${ELAPSED}s elapsed)"
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "Timeout waiting for PR merge. Triggering connector generation anyway..."
            echo "MERGE_SUCCESSFUL=timeout" >> $GITHUB_ENV
          fi

      - name: Trigger Connector Regeneration
        if: env.UPDATES_FOUND == 'true' && (env.MERGE_SUCCESSFUL == 'true' || env.MERGE_SUCCESSFUL == 'timeout')
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_PAT }}
        run: |
          echo "Triggering connector regeneration..."

          if [ ! -f "UPDATE_SUMMARY.txt" ]; then
            echo "UPDATE_SUMMARY.txt not found, skipping connector triggers"
            exit 0
          fi

          echo "UPDATE_SUMMARY.txt contents:"
          cat UPDATE_SUMMARY.txt
          echo ""
          echo "---"

          # Process each line in UPDATE_SUMMARY.txt
          # FORMAT: vendor/api: oldVersion -> newVersion -> openapi/vendor/api/VERSION
          while IFS= read -r line || [ -n "$line" ]; do
            echo "Processing line: '$line'"

            # Check if this line contains a specification update
            if echo "$line" | grep -qE "^[[:space:]]*[a-zA-Z]"; then

              # Extract vendor/api from the beginning of the line (before the colon)
              SPEC_PATH=$(echo "$line" | sed -E 's/^[[:space:]]*([a-zA-Z][^:]*):.*$/\1/' | xargs)

              # Validate we got a proper vendor/api path
              if [[ ! "$SPEC_PATH" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
                echo "Could not parse vendor/api from line, skipping"
                continue
              fi

              VENDOR=$(echo "$SPEC_PATH" | cut -d'/' -f1)
              API=$(echo "$SPEC_PATH" | cut -d'/' -f2)

              echo "Detected update for: $VENDOR/$API"

              # Extract the folder path using awk (more reliable than grep -P)
              # Get everything after the last arrow (->)
              FOLDER_PATH=$(echo "$line" | awk -F' -> ' '{print $NF}' | xargs)

              if [ -z "$FOLDER_PATH" ]; then
                echo "ERROR: Could not extract folder path from update summary for $VENDOR/$API"
                echo "Line content: $line"
                echo "Skipping this connector..."
                continue
              fi

              echo "Successfully extracted folder path: $FOLDER_PATH"

              # Extract just the version directory name from the full path
              # e.g., "openapi/twilio/twilio/1.0.0" -> "1.0.0"
              VERSION_DIR=$(echo "$FOLDER_PATH" | awk -F'/' '{print $NF}')

              if [ -z "$VERSION_DIR" ]; then
                echo "ERROR: Could not extract version directory from folder path"
                echo "Folder path: $FOLDER_PATH"
                echo "Skipping this connector..."
                continue
              fi

              echo "Extracted version directory: $VERSION_DIR"

              # Look up the connector repository from repos.json
              CONNECTOR_REPO=$(jq -r ".[] | select(.vendor==\"$VENDOR\" and .api==\"$API\") | .connectorRepo" repos.json)

              if [ -z "$CONNECTOR_REPO" ] || [ "$CONNECTOR_REPO" = "null" ]; then
                echo "No connector repository configured for $VENDOR/$API in repos.json"
                continue
              fi

              echo "Found connector repository: $CONNECTOR_REPO"

              # Construct the spec URL using the folder path
              SPEC_URL="https://raw.githubusercontent.com/orgAspec/api-specs/main/${FOLDER_PATH}/openapi.json"
              echo "Constructed spec URL: $SPEC_URL"

              # Verify the URL is accessible
              echo "Verifying spec URL accessibility..."
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SPEC_URL")
              if [ "$HTTP_CODE" != "200" ]; then
                echo "WARNING: JSON spec returned HTTP $HTTP_CODE. Checking if YAML exists..."
                # Try YAML as fallback
                SPEC_URL="https://raw.githubusercontent.com/orgAspec/api-specs/main/${FOLDER_PATH}/openapi.yaml"
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SPEC_URL")
                if [ "$HTTP_CODE" != "200" ]; then
                  echo "ERROR: Neither JSON nor YAML spec found at $FOLDER_PATH"
                  echo "Skipping this connector..."
                  continue
                else
                  echo "Found YAML spec instead (HTTP 200)"
                fi
              else
                echo "Spec URL verified successfully (HTTP 200)"
              fi

              # Trigger the connector repository workflow
              echo "Sending repository_dispatch event to $CONNECTOR_REPO..."

              gh api \
                repos/"$CONNECTOR_REPO"/dispatches \
                -X POST \
                -f event_type=openapi-update \
                -f client_payload[sender]=orgAspec/api-specs \
                -f client_payload[openapi_url]="$SPEC_URL" \
                -f client_payload[spec_version]="$VERSION_DIR" \
                && echo "✓ Successfully triggered connector regeneration for $CONNECTOR_REPO" \
                || echo "✗ Failed to trigger connector regeneration for $CONNECTOR_REPO"

            fi
          done < UPDATE_SUMMARY.txt

          echo ""
          echo "All connector regeneration triggers completed!"

      - name: Notify on failure
        if: failure() && env.UPDATES_FOUND == 'true'
        run: |
          if [ -n "$PR_NUMBER" ]; then
            gh pr comment "$PR_NUMBER" --body "⚠️ Connector regeneration workflow encountered an error. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
          fi
